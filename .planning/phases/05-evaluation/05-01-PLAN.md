---
phase: 05-evaluation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/features/evaluation/hooks/useStartEvaluation.ts
  - frontend/src/features/evaluation/hooks/useEvaluations.ts
  - frontend/src/features/evaluation/hooks/useEvaluation.ts
  - frontend/src/features/evaluation/components/EvaluationForm.tsx
  - frontend/src/features/evaluation/components/ReuseQuestionsSelect.tsx
autonomous: true

must_haves:
  truths:
    - "User can configure evaluation parameters (folder, top-k, enhancer, reranking, questions)"
    - "User can select a previous evaluation to reuse its questions"
    - "User can start an evaluation and see the evaluation ID"
    - "User sees loading state while evaluation runs"
  artifacts:
    - path: "frontend/src/features/evaluation/hooks/useStartEvaluation.ts"
      provides: "Mutation for POST /evaluation/start"
      exports: ["useStartEvaluation"]
    - path: "frontend/src/features/evaluation/hooks/useEvaluations.ts"
      provides: "Query for GET /evaluations list"
      exports: ["useEvaluations"]
    - path: "frontend/src/features/evaluation/hooks/useEvaluation.ts"
      provides: "Query for GET /evaluation/{id}"
      exports: ["useEvaluation"]
    - path: "frontend/src/features/evaluation/components/EvaluationForm.tsx"
      provides: "Form with all evaluation controls"
      exports: ["EvaluationForm"]
    - path: "frontend/src/features/evaluation/components/ReuseQuestionsSelect.tsx"
      provides: "Dropdown for selecting source evaluation"
      exports: ["ReuseQuestionsSelect"]
  key_links:
    - from: "frontend/src/features/evaluation/components/EvaluationForm.tsx"
      to: "@/features/ingestion/components/FolderSelect"
      via: "import for folder dropdown"
      pattern: "import.*FolderSelect.*from.*ingestion"
    - from: "frontend/src/features/evaluation/hooks/useStartEvaluation.ts"
      to: "/evaluation/start"
      via: "apiClient POST"
      pattern: "apiClient.*evaluation/start"
---

<objective>
Create TanStack Query hooks for evaluation API endpoints and build the EvaluationForm component with all parameter controls.

Purpose: Enable users to configure and start evaluations with folder selection, retrieval parameters, questions-per-doc slider, and question reuse from previous evaluations.

Output: Three hooks (useStartEvaluation, useEvaluations, useEvaluation) and EvaluationForm with ReuseQuestionsSelect components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-evaluation/05-RESEARCH.md

# Existing patterns to follow
@frontend/src/features/ingestion/hooks/useStartJob.ts
@frontend/src/features/ingestion/hooks/useFolders.ts
@frontend/src/features/ingestion/components/FolderSelect.tsx
@frontend/src/features/ingestion/components/IngestionForm.tsx
@frontend/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create evaluation TanStack Query hooks</name>
  <files>
    frontend/src/features/evaluation/hooks/useStartEvaluation.ts
    frontend/src/features/evaluation/hooks/useEvaluations.ts
    frontend/src/features/evaluation/hooks/useEvaluation.ts
  </files>
  <action>
Create three hooks following existing patterns from ingestion:

1. `useStartEvaluation.ts`:
   - Use `useMutation` for POST `/evaluation/start`
   - Takes `EvaluationRequest` from `@/types/api`
   - Returns `EvaluationStartResponse`
   - On success, invalidate `['evaluations']` query to refresh list
   - Note: This runs SYNCHRONOUSLY - no polling needed, mutation blocks until complete

2. `useEvaluations.ts`:
   - Use `useQuery` for GET `/evaluations`
   - Accept optional `limit` parameter (default 50)
   - Query key: `['evaluations', limit]`
   - Returns `EvaluationsListResponse`

3. `useEvaluation.ts`:
   - Use `useQuery` for GET `/evaluation/{evaluationId}`
   - Accept `evaluationId: string | null`
   - Query key: `['evaluation', evaluationId]`
   - `enabled: !!evaluationId` (only fetch when ID provided)
   - Returns `EvaluationStatusResponse`

Import `apiClient` from `@/lib/api-client`. Follow exact patterns from `useStartJob.ts` and `useFolders.ts`.
  </action>
  <verify>
Files exist and TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
Three hook files created with correct TanStack Query patterns, types imported from `@/types/api`, apiClient calls to correct endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReuseQuestionsSelect and EvaluationForm components</name>
  <files>
    frontend/src/features/evaluation/components/ReuseQuestionsSelect.tsx
    frontend/src/features/evaluation/components/EvaluationForm.tsx
  </files>
  <action>
Create two components following existing patterns from ingestion and retrieval:

1. `ReuseQuestionsSelect.tsx` (EVAL-06):
   - Props: `value: string | undefined`, `onChange: (value: string | undefined) => void`, `evaluations: EvaluationStatusResponse[]`, `disabled?: boolean`
   - Use shadcn Select component
   - First option: "Generate new questions" with value "none"
   - Map completed evaluations only (`status === 'completed'`) to SelectItems
   - Display: `{evaluation_id.slice(0, 8)}... ({folder_path})`
   - Convert "none" to undefined on change

2. `EvaluationForm.tsx` (EVAL-01 through EVAL-08):
   - Props: `onSubmit: (request: EvaluationRequest) => void`, `isPending: boolean`, `evaluations: EvaluationStatusResponse[]`
   - Local state for: `folderPath`, `topK` (default 10), `useQueryEnhancer` (default false), `useReranking` (default false), `numQuestionsPerDoc` (default 1), `sourceEvaluationId`
   - Import and use `FolderSelect` from `@/features/ingestion/components/FolderSelect` (EVAL-01)
   - Top-K Slider: min 1, max 50, step 1 (EVAL-02)
   - Questions per doc Slider: min 1, max 10, step 1 - DISABLE when sourceEvaluationId is set (EVAL-05)
   - Checkboxes for useQueryEnhancer (EVAL-03) and useReranking (EVAL-04) using `checked === true` pattern
   - ReuseQuestionsSelect for source_evaluation_id (EVAL-06)
   - Submit button with Play icon, shows Loader2 + "Evaluating..." when isPending (EVAL-07)
   - `canSubmit = folderPath && !isPending`
   - Build EvaluationRequest and call onSubmit, map sourceEvaluationId to `source_evaluation_id: sourceEvaluationId ?? null`

Follow patterns from IngestionForm.tsx for layout. Use grid layout for parameter controls. Use Slider with `value={[topK]}` and `onValueChange={([value]) => setTopK(value)}` pattern.
  </action>
  <verify>
Files exist and TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
ReuseQuestionsSelect filters to completed evaluations and handles none/undefined conversion. EvaluationForm has all 6 controls (folder, top-k, enhancer, reranking, questions, reuse), disables questions slider when reusing, shows loading state when isPending.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire EvaluationForm into EvaluationPage</name>
  <files>
    frontend/src/features/evaluation/EvaluationPage.tsx
  </files>
  <action>
Update the placeholder EvaluationPage to integrate EvaluationForm and show evaluation start results:

1. Import: `useState` from react, `CheckCircle`, `XCircle` from lucide-react, `toast` from sonner, Card components, EvaluationForm, useStartEvaluation, useEvaluations

2. State:
   - `const [lastEvaluationId, setLastEvaluationId] = useState<string | null>(null)`

3. Hooks:
   - `const { mutate: startEvaluation, isPending, isError, error, reset } = useStartEvaluation()`
   - `const { data: evaluationsData } = useEvaluations()`
   - `const evaluations = evaluationsData?.evaluations ?? []`

4. Handler:
   ```typescript
   const handleSubmit = (request: EvaluationRequest) => {
     reset()
     setLastEvaluationId(null)
     startEvaluation(request, {
       onSuccess: (data) => {
         setLastEvaluationId(data.evaluation_id)
         toast.success('Evaluation Complete', {
           description: `Evaluation ${data.evaluation_id.slice(0, 8)}... finished`,
         })
       },
     })
   }
   ```

5. Layout:
   - Header with title "Evaluation" and description "Test retrieval system performance"
   - Card with CardHeader "Start Evaluation" and CardContent containing EvaluationForm
   - After form, show evaluation result when lastEvaluationId exists:
     - Success: Green background with CheckCircle, "Evaluation complete" message with ID
   - Error state card below main card (pattern from IngestionPage)

Note: Unlike ingestion, evaluation is synchronous - the mutation completes when evaluation finishes. No polling needed.
  </action>
  <verify>
Run `cd frontend && npm run dev`, navigate to Evaluation tab, see form with all controls, select a folder, adjust parameters, click Start Evaluation (will fail if no backend but should show loading state).
  </verify>
  <done>
EvaluationPage shows form card, form has all parameter controls including FolderSelect, sliders, checkboxes, and reuse dropdown. Submit shows loading state. Success shows evaluation ID. Error displays with dismiss button.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run dev` starts without errors
3. Navigate to Evaluation tab - see form with folder dropdown, sliders, checkboxes
4. Selecting a source evaluation disables the questions-per-doc slider
5. Clicking Start Evaluation shows loading state (button disabled, spinner)
</verification>

<success_criteria>
- EVAL-01: Folder dropdown present and functional
- EVAL-02: Top-K slider present (1-50 range)
- EVAL-03: Query enhancer checkbox present
- EVAL-04: Reranking checkbox present
- EVAL-05: Questions per document slider present (1-10 range), disabled when reusing
- EVAL-06: Reuse questions dropdown present, shows completed evaluations
- EVAL-07: Start Evaluation button triggers mutation
- EVAL-08: Evaluation ID displayed after completion
- EVAL-13 (partial): Loading state shown during evaluation
</success_criteria>

<output>
After completion, create `.planning/phases/05-evaluation/05-01-SUMMARY.md`
</output>
