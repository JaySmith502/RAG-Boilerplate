---
phase: 05-evaluation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/features/evaluation/components/ComparisonTable.tsx
  - frontend/src/features/evaluation/EvaluationPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple evaluations via checkboxes"
    - "User can see selected evaluations side by side in a table"
    - "Comparison table shows configuration and metrics for each evaluation"
    - "Empty selection shows helpful message"
  artifacts:
    - path: "frontend/src/features/evaluation/components/ComparisonTable.tsx"
      provides: "Side-by-side comparison table with checkbox selection"
      exports: ["ComparisonTable"]
  key_links:
    - from: "frontend/src/features/evaluation/EvaluationPage.tsx"
      to: "ComparisonTable"
      via: "passes evaluations and selection state"
      pattern: "<ComparisonTable.*evaluations.*selected"
---

<objective>
Create the comparison table allowing users to select multiple evaluations and view them side by side.

Purpose: Users need to compare metrics across different retrieval configurations to understand which settings (top-k, enhancer, reranking) produce the best results. The comparison table provides a clear view of all metrics in one place.

Output: ComparisonTable component with checkbox selection integrated into EvaluationPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-evaluation/05-RESEARCH.md
@.planning/phases/05-evaluation/05-01-SUMMARY.md

# Existing table patterns
@frontend/src/features/ingestion/components/JobHistoryTable.tsx
@frontend/src/features/retrieval/components/ResultsTable.tsx
@frontend/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComparisonTable component</name>
  <files>
    frontend/src/features/evaluation/components/ComparisonTable.tsx
  </files>
  <action>
Create ComparisonTable with checkbox selection and side-by-side metrics display (EVAL-12):

Props:
```typescript
interface ComparisonTableProps {
  evaluations: EvaluationStatusResponse[]
  selectedIds: Set<string>
  onSelectionChange: (ids: Set<string>) => void
}
```

Structure:
1. Use shadcn Table, Checkbox components

2. Table header row:
   - Empty cell (for checkbox column)
   - "Evaluation ID"
   - "Folder"
   - "Top-K"
   - "Enhancer"
   - "Reranking"
   - "Hit Rate"
   - "MRR"
   - "Avg Score"

3. Table body:
   - Map over evaluations (only completed ones: `evaluations.filter(e => e.status === 'completed')`)
   - Each row:
     - Checkbox: `checked={selectedIds.has(e.evaluation_id)}`, onCheckedChange toggles in/out of Set
     - Evaluation ID: `{e.evaluation_id.slice(0, 8)}...` in monospace font
     - Folder: `{e.folder_path}`
     - Top-K: `{e.retrieve_params.top_k}` (cast retrieve_params as needed)
     - Enhancer: "Yes" / "No" based on `e.retrieve_params.use_query_enhancer`
     - Reranking: "Yes" / "No" based on `e.retrieve_params.use_reranking`
     - Hit Rate: `{results_summary?.hit_rate !== undefined ? (value * 100).toFixed(1) + '%' : 'N/A'}`
     - MRR: `{results_summary?.mrr?.toFixed(3) ?? 'N/A'}`
     - Avg Score: `{results_summary?.avg_score?.toFixed(3) ?? 'N/A'}`

4. Selected rows highlighting:
   - Add `className={selectedIds.has(e.evaluation_id) ? 'bg-muted/50' : ''}` to TableRow

5. Empty state:
   - If no completed evaluations: "No completed evaluations to compare"
   - If evaluations exist but none selected: Show table normally, rows are selectable

6. Selection helper functions:
   ```typescript
   const toggleSelection = (id: string) => {
     const newSet = new Set(selectedIds)
     if (newSet.has(id)) {
       newSet.delete(id)
     } else {
       newSet.add(id)
     }
     onSelectionChange(newSet)
   }
   ```

7. Type assertion for retrieve_params:
   - Cast as `{ top_k: number; use_query_enhancer: boolean; use_reranking: boolean }`
   - Or access via bracket notation with defaults
  </action>
  <verify>
Files exist and TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
ComparisonTable shows all completed evaluations with checkboxes, displays config and metrics columns, selected rows are highlighted, toggle selection works correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Comparison section to EvaluationPage</name>
  <files>
    frontend/src/features/evaluation/EvaluationPage.tsx
  </files>
  <action>
Update EvaluationPage to add the Comparison card section (EVAL-12):

1. Add imports: ComparisonTable

2. Add state:
   - `const [comparisonIds, setComparisonIds] = useState<Set<string>>(new Set())`

3. Add new Card after the Results card:
   ```tsx
   <Card>
     <CardHeader>
       <CardTitle>Compare Evaluations</CardTitle>
       <CardDescription>
         Select evaluations to compare their configurations and metrics
       </CardDescription>
     </CardHeader>
     <CardContent>
       <ComparisonTable
         evaluations={evaluations}
         selectedIds={comparisonIds}
         onSelectionChange={setComparisonIds}
       />
     </CardContent>
   </Card>
   ```

4. Summary of selected (optional enhancement):
   - Above the table, show: "Selected: {comparisonIds.size} evaluations"
   - Add "Clear selection" button if size > 0:
     ```tsx
     {comparisonIds.size > 0 && (
       <div className="flex items-center justify-between mb-4">
         <span className="text-sm text-muted-foreground">
           {comparisonIds.size} evaluation(s) selected
         </span>
         <Button
           variant="ghost"
           size="sm"
           onClick={() => setComparisonIds(new Set())}
         >
           Clear selection
         </Button>
       </div>
     )}
     ```

Final page structure should be:
1. Header (title + description)
2. Start Evaluation card (form)
3. Results card (single evaluation view)
4. Compare Evaluations card (multi-select table)
  </action>
  <verify>
Run `cd frontend && npm run dev`, navigate to Evaluation tab, scroll down to see Compare Evaluations card, see table with checkboxes, click checkboxes to select/deselect rows, selected rows highlight, clear selection works.
  </verify>
  <done>
EvaluationPage has three cards: Start Evaluation, Results, Compare Evaluations. Comparison table shows all completed evaluations with checkboxes, displays config columns (top-k, enhancer, reranking) and metrics columns (hit rate, MRR, avg score). Selection count and clear button appear when items selected.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run dev` starts without errors
3. Navigate to Evaluation tab - see Compare Evaluations card at bottom
4. Table shows all completed evaluations with checkboxes
5. Table columns: Checkbox, ID, Folder, Top-K, Enhancer, Reranking, Hit Rate, MRR, Avg Score
6. Clicking checkboxes toggles selection, selected rows are highlighted
7. Selection count shows above table, clear button clears all selections
</verification>

<success_criteria>
- EVAL-12: Comparison table shows all evaluations side by side with config and metrics
- Checkboxes allow selecting multiple evaluations
- Selected rows are visually highlighted
- Configuration columns (Top-K, Enhancer, Reranking) displayed
- Metric columns (Hit Rate, MRR, Avg Score) displayed with proper formatting
- Clear selection button functional
</success_criteria>

<output>
After completion, create `.planning/phases/05-evaluation/05-03-SUMMARY.md`
</output>
