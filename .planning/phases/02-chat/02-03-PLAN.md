---
phase: 02-chat
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/features/chat/components/SourceCitations.tsx
  - frontend/src/features/chat/components/MessageActions.tsx
  - frontend/src/features/chat/utils/clipboard.ts
  - frontend/src/features/chat/components/MessageBubble.tsx
  - frontend/src/features/chat/ChatPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see source citations with assistant responses"
    - "User can expand and collapse source citations"
    - "User can copy assistant response text to clipboard"
    - "Toast notification confirms copy success or failure"
    - "Error state shows retry option"
    - "Loading indicator visible while waiting for response"
  artifacts:
    - path: "frontend/src/features/chat/components/SourceCitations.tsx"
      provides: "Collapsible source citations display"
      exports: ["SourceCitations"]
    - path: "frontend/src/features/chat/components/MessageActions.tsx"
      provides: "Copy button and other message actions"
      exports: ["MessageActions"]
    - path: "frontend/src/features/chat/utils/clipboard.ts"
      provides: "Clipboard utility with toast feedback"
      exports: ["copyToClipboard"]
  key_links:
    - from: "frontend/src/features/chat/components/MessageBubble.tsx"
      to: "SourceCitations"
      via: "conditional render for assistant messages"
      pattern: "<SourceCitations"
    - from: "frontend/src/features/chat/components/MessageBubble.tsx"
      to: "MessageActions"
      via: "conditional render for assistant messages"
      pattern: "<MessageActions"
    - from: "frontend/src/features/chat/components/MessageActions.tsx"
      to: "copyToClipboard"
      via: "button onClick handler"
      pattern: "copyToClipboard\\("
---

<objective>
Add source citations with expand/collapse functionality, copy-to-clipboard for assistant responses, and complete loading/error states with retry capability.

Purpose: Complete the chat experience with citation visibility, response actions, and robust error handling.
Output: Polished chat interface with all CHAT requirements fully addressed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat/02-RESEARCH.md
@.planning/phases/02-chat/02-01-SUMMARY.md
@.planning/phases/02-chat/02-02-SUMMARY.md

# Key existing files
@frontend/src/features/chat/components/MessageBubble.tsx
@frontend/src/features/chat/ChatPage.tsx
@frontend/src/components/ui/collapsible.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clipboard utility and SourceCitations component</name>
  <files>
    frontend/src/features/chat/utils/clipboard.ts
    frontend/src/features/chat/components/SourceCitations.tsx
  </files>
  <action>
    **clipboard.ts** - Clipboard utility with toast feedback:
    ```typescript
    import { toast } from 'sonner'

    export async function copyToClipboard(text: string): Promise<boolean> {
      if (!navigator?.clipboard) {
        toast.error('Clipboard not supported in this browser')
        return false
      }

      try {
        await navigator.clipboard.writeText(text)
        toast.success('Copied to clipboard')
        return true
      } catch (error) {
        console.error('Clipboard error:', error)
        toast.error('Failed to copy to clipboard')
        return false
      }
    }
    ```

    **SourceCitations.tsx** - Collapsible sources display:
    ```typescript
    import { useState } from 'react'
    import { ChevronDown, FileText } from 'lucide-react'
    import {
      Collapsible,
      CollapsibleContent,
      CollapsibleTrigger,
    } from '@/components/ui/collapsible'
    import { cn } from '@/lib/utils'

    interface SourceCitationsProps {
      sources: string[]
    }

    export function SourceCitations({ sources }: SourceCitationsProps) {
      const [isOpen, setIsOpen] = useState(false)

      if (!sources || sources.length === 0) {
        return null
      }

      return (
        <Collapsible open={isOpen} onOpenChange={setIsOpen} className="mt-3 pt-3 border-t border-border/50">
          <CollapsibleTrigger className="flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors w-full">
            <ChevronDown
              className={cn(
                'h-3 w-3 transition-transform duration-200',
                isOpen && 'rotate-180'
              )}
            />
            <FileText className="h-3 w-3" />
            <span>
              {sources.length} source{sources.length !== 1 ? 's' : ''}
            </span>
          </CollapsibleTrigger>
          <CollapsibleContent className="mt-2">
            <ul className="space-y-1.5">
              {sources.map((source, index) => (
                <li
                  key={index}
                  className="text-xs text-muted-foreground pl-5 truncate"
                  title={source}
                >
                  {source}
                </li>
              ))}
            </ul>
          </CollapsibleContent>
        </Collapsible>
      )
    }
    ```

    Key design choices:
    - Returns null if no sources (handles empty array gracefully)
    - Collapsed by default (user must click to expand)
    - Visual separator (border-t) between message and sources
    - Truncate long source names with title attribute for full text on hover
    - Chevron rotation animation for open/closed state
  </action>
  <verify>
    ```bash
    cd frontend && pnpm exec tsc --noEmit
    ```
    TypeScript compiles without errors.
  </verify>
  <done>Clipboard utility and SourceCitations component created with collapsible behavior</done>
</task>

<task type="auto">
  <name>Task 2: Create MessageActions component and update MessageBubble</name>
  <files>
    frontend/src/features/chat/components/MessageActions.tsx
    frontend/src/features/chat/components/MessageBubble.tsx
  </files>
  <action>
    **MessageActions.tsx** - Copy button and action container:
    ```typescript
    import { Copy, Check } from 'lucide-react'
    import { useState } from 'react'
    import { Button } from '@/components/ui/button'
    import { copyToClipboard } from '../utils/clipboard'

    interface MessageActionsProps {
      content: string
    }

    export function MessageActions({ content }: MessageActionsProps) {
      const [copied, setCopied] = useState(false)

      const handleCopy = async () => {
        const success = await copyToClipboard(content)
        if (success) {
          setCopied(true)
          setTimeout(() => setCopied(false), 2000)
        }
      }

      return (
        <div className="flex items-center gap-1 mt-2 -ml-1">
          <Button
            variant="ghost"
            size="sm"
            onClick={handleCopy}
            className="h-7 px-2 text-xs text-muted-foreground hover:text-foreground"
          >
            {copied ? (
              <>
                <Check className="h-3 w-3 mr-1" />
                Copied
              </>
            ) : (
              <>
                <Copy className="h-3 w-3 mr-1" />
                Copy
              </>
            )}
          </Button>
        </div>
      )
    }
    ```

    **Update MessageBubble.tsx** - Add sources and actions:
    ```typescript
    import { cn } from '@/lib/utils'
    import { SourceCitations } from './SourceCitations'
    import { MessageActions } from './MessageActions'
    import type { Message } from '@/types/api'

    interface MessageBubbleProps {
      message: Message
      isPending?: boolean
    }

    export function MessageBubble({ message, isPending }: MessageBubbleProps) {
      const isUser = message.role === 'user'
      const isAssistant = message.role === 'assistant'

      const formatTimestamp = (timestamp: string) => {
        const date = new Date(timestamp)
        return date.toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit',
        })
      }

      return (
        <div
          className={cn(
            'flex w-full',
            isUser ? 'justify-end' : 'justify-start'
          )}
        >
          <div
            className={cn(
              'max-w-[80%] rounded-2xl px-4 py-3',
              isUser
                ? 'bg-primary text-primary-foreground rounded-br-md'
                : 'bg-muted rounded-bl-md',
              isPending && 'opacity-70'
            )}
          >
            <p className="whitespace-pre-wrap break-words">{message.content}</p>

            {/* Timestamp */}
            <p
              className={cn(
                'text-xs mt-1',
                isUser ? 'text-primary-foreground/70' : 'text-muted-foreground'
              )}
            >
              {formatTimestamp(message.timestamp)}
            </p>

            {/* Source citations - assistant only */}
            {isAssistant && message.sources && message.sources.length > 0 && (
              <SourceCitations sources={message.sources} />
            )}

            {/* Message actions - assistant only, not pending */}
            {isAssistant && !isPending && (
              <MessageActions content={message.content} />
            )}
          </div>
        </div>
      )
    }
    ```

    Key design choices:
    - Copy button shows "Copied" checkmark for 2 seconds after successful copy
    - Actions only shown on assistant messages (not user messages)
    - Actions hidden during pending state
    - Toast notification provides feedback (success/error)
    - SourceCitations only rendered if sources array has items
  </action>
  <verify>
    ```bash
    cd frontend && pnpm exec tsc --noEmit
    ```
    TypeScript compiles without errors.
  </verify>
  <done>MessageActions component created, MessageBubble updated with sources and copy button</done>
</task>

<task type="auto">
  <name>Task 3: Add complete error handling with retry to ChatPage</name>
  <files>
    frontend/src/features/chat/ChatPage.tsx
  </files>
  <action>
    **Update ChatPage.tsx** - Add retry functionality and improved error/loading states:
    ```typescript
    import { useCallback } from 'react'
    import { RefreshCw, Loader2 } from 'lucide-react'
    import { PageContainer } from '@/components/layout/page-container'
    import { Button } from '@/components/ui/button'
    import { Skeleton } from '@/components/ui/skeleton'
    import { MessageList } from './components/MessageList'
    import { MessageInput } from './components/MessageInput'
    import { useSession } from './hooks/useSession'
    import { useSendMessage } from './hooks/useSendMessage'

    interface ChatPageProps {
      selectedSessionId: string | null
      onSelectSession: (sessionId: string | null) => void
    }

    export function ChatPage({ selectedSessionId, onSelectSession }: ChatPageProps) {
      const {
        data: session,
        isLoading: isLoadingSession,
        isError: isSessionError,
        refetch: refetchSession,
        isFetching: isFetchingSession,
      } = useSession(selectedSessionId)

      const {
        mutate: sendMessage,
        isPending: isSending,
        variables: pendingVariables,
        isError: isSendError,
        error: sendError,
        reset: resetSendError,
      } = useSendMessage()

      const handleSend = useCallback(
        (message: string) => {
          // Clear any previous error
          resetSendError()

          sendMessage(
            {
              message,
              session_id: selectedSessionId,
            },
            {
              onSuccess: (data) => {
                if (!selectedSessionId && data.session_id) {
                  onSelectSession(data.session_id)
                }
              },
            }
          )
        },
        [selectedSessionId, sendMessage, onSelectSession, resetSendError]
      )

      const handleRetry = useCallback(() => {
        if (pendingVariables?.message) {
          handleSend(pendingVariables.message)
        }
      }, [pendingVariables, handleSend])

      const messages = session?.messages ?? []
      const pendingMessage = isSending ? pendingVariables?.message : null

      // Loading state for existing session
      if (selectedSessionId && isLoadingSession) {
        return (
          <PageContainer fullWidth className="flex flex-col h-[calc(100vh-4rem)] p-0">
            <div className="flex-1 p-4 space-y-4">
              <div className="flex justify-start">
                <Skeleton className="h-16 w-3/4 rounded-2xl" />
              </div>
              <div className="flex justify-end">
                <Skeleton className="h-12 w-1/2 rounded-2xl" />
              </div>
              <div className="flex justify-start">
                <Skeleton className="h-20 w-2/3 rounded-2xl" />
              </div>
            </div>
            <div className="border-t p-4">
              <div className="flex gap-2 items-end max-w-4xl mx-auto">
                <Skeleton className="h-11 flex-1" />
                <Skeleton className="h-11 w-11" />
              </div>
            </div>
          </PageContainer>
        )
      }

      // Session load error state
      if (selectedSessionId && isSessionError) {
        return (
          <PageContainer fullWidth className="flex flex-col h-[calc(100vh-4rem)] p-0">
            <div className="flex-1 flex items-center justify-center">
              <div className="text-center space-y-4">
                <p className="text-lg font-medium text-destructive">Failed to load conversation</p>
                <p className="text-sm text-muted-foreground">There was a problem loading this chat session</p>
                <Button
                  variant="outline"
                  onClick={() => refetchSession()}
                  disabled={isFetchingSession}
                >
                  {isFetchingSession ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Retrying...
                    </>
                  ) : (
                    <>
                      <RefreshCw className="h-4 w-4 mr-2" />
                      Try Again
                    </>
                  )}
                </Button>
              </div>
            </div>
          </PageContainer>
        )
      }

      return (
        <PageContainer fullWidth className="flex flex-col h-[calc(100vh-4rem)] p-0">
          <MessageList messages={messages} pendingMessage={pendingMessage} />

          {/* Send error banner */}
          {isSendError && (
            <div className="border-t border-destructive/50 bg-destructive/10 px-4 py-3">
              <div className="flex items-center justify-between max-w-4xl mx-auto">
                <p className="text-sm text-destructive">
                  Failed to send message: {sendError instanceof Error ? sendError.message : 'Unknown error'}
                </p>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleRetry}
                  className="border-destructive/50 text-destructive hover:bg-destructive/10"
                >
                  <RefreshCw className="h-3 w-3 mr-1" />
                  Retry
                </Button>
              </div>
            </div>
          )}

          <MessageInput
            onSend={handleSend}
            disabled={isSending}
            placeholder={isSending ? 'Sending...' : 'Type a message...'}
          />
        </PageContainer>
      )
    }
    ```

    Key design choices:
    - Retry button for session load errors (calls refetchSession)
    - Send error shown as banner above input with retry option
    - Reset send error when user types a new message
    - Loading spinner during retry operations
    - Placeholder text changes to "Sending..." during send
    - Error message shows actual error detail when available
  </action>
  <verify>
    1. `cd frontend && pnpm build` - Build succeeds
    2. `cd frontend && pnpm dev` - Start dev server, verify:
       - Assistant messages show collapsible source citations (if present)
       - Clicking source count expands/collapses the list
       - Copy button appears on assistant messages
       - Clicking Copy shows toast "Copied to clipboard"
       - Button shows checkmark and "Copied" for 2 seconds
       - If send fails, error banner appears with retry button
       - If session load fails, retry button appears
  </verify>
  <done>
    Error handling complete with retry. Source citations collapsible. Copy button functional with feedback. All loading states polished.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `cd frontend && pnpm build` passes
2. Source citations:
   - Assistant messages show "{N} sources" trigger
   - Clicking expands to show source list
   - Clicking again collapses
   - Messages without sources show no citation section
3. Copy functionality:
   - Copy button visible on assistant messages only
   - Click shows toast notification
   - Button changes to checkmark briefly
4. Error handling:
   - Network errors on send show retry banner
   - Session load errors show centered retry UI
   - Retry buttons work and show loading state
5. No TypeScript errors, clean build
</verification>

<success_criteria>
- SourceCitations component renders and is collapsible
- Copy button works with clipboard API and shows toast feedback
- Error states show retry options that function correctly
- All CHAT requirements fully addressed:
  - CHAT-01: Session list in sidebar (Plan 01)
  - CHAT-02: Select session to view history (Plan 01)
  - CHAT-03: New chat button (Plan 01)
  - CHAT-04: Messages as chat bubbles (Plan 02)
  - CHAT-05: Timestamps displayed (Plan 02)
  - CHAT-06: Text input (Plan 02)
  - CHAT-07: Send button (Plan 02)
  - CHAT-08: Input cleared after send (Plan 02)
  - CHAT-09: Source citations displayed (Plan 03)
  - CHAT-10: Sources collapsible (Plan 03)
  - CHAT-11: Loading state (Plan 02 + 03)
  - CHAT-12: Error state with retry (Plan 03)
  - CHAT-13: Copy button (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat/02-03-SUMMARY.md`
</output>
