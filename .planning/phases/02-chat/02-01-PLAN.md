---
phase: 02-chat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/ui/scroll-area.tsx
  - frontend/src/components/ui/collapsible.tsx
  - frontend/src/components/ui/card.tsx
  - frontend/src/components/ui/textarea.tsx
  - frontend/src/features/chat/hooks/useSessions.ts
  - frontend/src/features/chat/hooks/useSession.ts
  - frontend/src/features/chat/hooks/useSendMessage.ts
  - frontend/src/features/chat/components/ChatSessionList.tsx
  - frontend/src/components/layout/app-sidebar.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of chat sessions in the sidebar"
    - "User can click a session to select it"
    - "User can click New Chat button to start a new conversation"
    - "Selected session is visually highlighted"
  artifacts:
    - path: "frontend/src/features/chat/hooks/useSessions.ts"
      provides: "Session list query hook"
      exports: ["useSessions"]
    - path: "frontend/src/features/chat/hooks/useSession.ts"
      provides: "Single session query hook"
      exports: ["useSession"]
    - path: "frontend/src/features/chat/hooks/useSendMessage.ts"
      provides: "Chat mutation hook"
      exports: ["useSendMessage"]
    - path: "frontend/src/features/chat/components/ChatSessionList.tsx"
      provides: "Session list UI component"
      exports: ["ChatSessionList"]
  key_links:
    - from: "frontend/src/features/chat/hooks/useSessions.ts"
      to: "/sessions"
      via: "apiClient fetch"
      pattern: "apiClient.*sessions"
    - from: "frontend/src/features/chat/components/ChatSessionList.tsx"
      to: "useSessions"
      via: "hook import and call"
      pattern: "useSessions\\(\\)"
    - from: "frontend/src/components/layout/app-sidebar.tsx"
      to: "ChatSessionList"
      via: "component import and render"
      pattern: "<ChatSessionList"
---

<objective>
Install required shadcn components and create TanStack Query hooks for chat functionality, then build the session list component for the sidebar.

Purpose: Establish the data layer and session management UI that all other chat features depend on.
Output: Working session list in sidebar with selection, new chat button, and data fetching hooks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat/02-RESEARCH.md

# Key existing files
@frontend/src/lib/api-client.ts
@frontend/src/types/api.ts
@frontend/src/components/layout/app-sidebar.tsx
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn components for chat UI</name>
  <files>
    frontend/src/components/ui/scroll-area.tsx
    frontend/src/components/ui/collapsible.tsx
    frontend/src/components/ui/card.tsx
    frontend/src/components/ui/textarea.tsx
  </files>
  <action>
    Run shadcn CLI to add required components:
    ```bash
    cd frontend && npx shadcn@latest add scroll-area collapsible card textarea
    ```

    These components are needed for:
    - scroll-area: Message list scrolling
    - collapsible: Source citations expand/collapse
    - card: Message containers (optional but useful)
    - textarea: Message input

    Verify all four component files are created in `frontend/src/components/ui/`.
  </action>
  <verify>
    All four files exist:
    - `ls frontend/src/components/ui/scroll-area.tsx`
    - `ls frontend/src/components/ui/collapsible.tsx`
    - `ls frontend/src/components/ui/card.tsx`
    - `ls frontend/src/components/ui/textarea.tsx`
  </verify>
  <done>Four shadcn components installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create TanStack Query hooks for chat data</name>
  <files>
    frontend/src/features/chat/hooks/useSessions.ts
    frontend/src/features/chat/hooks/useSession.ts
    frontend/src/features/chat/hooks/useSendMessage.ts
  </files>
  <action>
    Create hooks directory and three hook files:

    **useSessions.ts** - Fetch all sessions:
    ```typescript
    import { useQuery } from '@tanstack/react-query'
    import { apiClient } from '@/lib/api-client'
    import type { SessionsListResponse } from '@/types/api'

    export function useSessions() {
      return useQuery({
        queryKey: ['sessions'],
        queryFn: () => apiClient<SessionsListResponse>('/sessions'),
      })
    }
    ```

    **useSession.ts** - Fetch single session with messages:
    ```typescript
    import { useQuery, keepPreviousData } from '@tanstack/react-query'
    import { apiClient } from '@/lib/api-client'
    import type { Session } from '@/types/api'

    export function useSession(sessionId: string | null) {
      return useQuery({
        queryKey: ['session', sessionId],
        queryFn: () => apiClient<Session>(`/sessions/${sessionId}`),
        enabled: !!sessionId,
        placeholderData: keepPreviousData,
      })
    }
    ```

    **useSendMessage.ts** - Send chat message mutation:
    ```typescript
    import { useMutation, useQueryClient } from '@tanstack/react-query'
    import { apiClient } from '@/lib/api-client'
    import type { ChatRequest, ChatResponse } from '@/types/api'

    export function useSendMessage() {
      const queryClient = useQueryClient()

      return useMutation({
        mutationFn: async (request: ChatRequest) => {
          return apiClient<ChatResponse>('/chat', {
            method: 'POST',
            body: request,
          })
        },
        onSuccess: (data) => {
          // Invalidate session to refetch with new messages
          queryClient.invalidateQueries({
            queryKey: ['session', data.session_id]
          })
          // Invalidate sessions list for updated timestamps
          queryClient.invalidateQueries({
            queryKey: ['sessions']
          })
        },
      })
    }
    ```

    Follow patterns from research: use `keepPreviousData` to prevent flash during refetch, use `enabled` for conditional fetching.
  </action>
  <verify>
    ```bash
    cd frontend && pnpm exec tsc --noEmit
    ```
    TypeScript compiles without errors.
  </verify>
  <done>Three TanStack Query hooks created: useSessions, useSession, useSendMessage</done>
</task>

<task type="auto">
  <name>Task 3: Create ChatSessionList component and integrate into sidebar</name>
  <files>
    frontend/src/features/chat/components/ChatSessionList.tsx
    frontend/src/components/layout/app-sidebar.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **ChatSessionList.tsx** - Session list for sidebar:
    ```typescript
    import { Plus } from 'lucide-react'
    import { Button } from '@/components/ui/button'
    import { ScrollArea } from '@/components/ui/scroll-area'
    import { Skeleton } from '@/components/ui/skeleton'
    import {
      SidebarGroup,
      SidebarGroupContent,
      SidebarGroupLabel,
      SidebarMenu,
      SidebarMenuButton,
      SidebarMenuItem,
      SidebarGroupAction,
    } from '@/components/ui/sidebar'
    import { useSessions } from '../hooks/useSessions'
    import type { Session } from '@/types/api'

    interface ChatSessionListProps {
      selectedSessionId: string | null
      onSelectSession: (sessionId: string | null) => void
    }

    export function ChatSessionList({
      selectedSessionId,
      onSelectSession,
    }: ChatSessionListProps) {
      const { data, isLoading, isError } = useSessions()

      const handleNewChat = () => {
        onSelectSession(null) // null indicates new chat
      }

      const formatDate = (dateString: string) => {
        const date = new Date(dateString)
        return date.toLocaleDateString(undefined, {
          month: 'short',
          day: 'numeric',
        })
      }

      const getSessionTitle = (session: Session) => {
        // Use first user message as title, or fallback
        const firstUserMessage = session.messages.find(m => m.role === 'user')
        if (firstUserMessage) {
          return firstUserMessage.content.slice(0, 30) + (firstUserMessage.content.length > 30 ? '...' : '')
        }
        return `Chat ${formatDate(session.created_at)}`
      }

      return (
        <SidebarGroup>
          <SidebarGroupLabel>Chat History</SidebarGroupLabel>
          <SidebarGroupAction onClick={handleNewChat} title="New Chat">
            <Plus className="h-4 w-4" />
          </SidebarGroupAction>
          <SidebarGroupContent>
            {isLoading ? (
              <div className="space-y-2 px-2">
                <Skeleton className="h-8 w-full" />
                <Skeleton className="h-8 w-full" />
                <Skeleton className="h-8 w-full" />
              </div>
            ) : isError ? (
              <div className="px-2 py-4 text-sm text-muted-foreground">
                Failed to load sessions
              </div>
            ) : !data?.sessions.length ? (
              <div className="px-2 py-4 text-sm text-muted-foreground">
                No conversations yet
              </div>
            ) : (
              <ScrollArea className="h-[200px]">
                <SidebarMenu>
                  {data.sessions.map((session) => (
                    <SidebarMenuItem key={session.session_id}>
                      <SidebarMenuButton
                        isActive={selectedSessionId === session.session_id}
                        onClick={() => onSelectSession(session.session_id)}
                        className="flex flex-col items-start gap-0.5 h-auto py-2"
                      >
                        <span className="truncate w-full text-left">
                          {getSessionTitle(session)}
                        </span>
                        <span className="text-xs text-muted-foreground">
                          {formatDate(session.updated_at)}
                        </span>
                      </SidebarMenuButton>
                    </SidebarMenuItem>
                  ))}
                </SidebarMenu>
              </ScrollArea>
            )}
          </SidebarGroupContent>
        </SidebarGroup>
      )
    }
    ```

    **Update app-sidebar.tsx** - Add ChatSessionList below navigation, accept session props:
    ```typescript
    // Add imports
    import { ChatSessionList } from '@/features/chat/components/ChatSessionList'

    // Update interface
    interface AppSidebarProps {
      activeSection: string
      onSectionChange: (section: string) => void
      selectedSessionId: string | null
      onSelectSession: (sessionId: string | null) => void
    }

    // Add ChatSessionList in Sidebar after Navigation group (conditional on chat section):
    {activeSection === 'chat' && (
      <ChatSessionList
        selectedSessionId={selectedSessionId}
        onSelectSession={onSelectSession}
      />
    )}
    ```

    **Update App.tsx** - Add session state and pass to sidebar and ChatPage:
    ```typescript
    // Add state
    const [selectedSessionId, setSelectedSessionId] = useState<string | null>(null)

    // Update AppSidebar props
    <AppSidebar
      activeSection={activeSection}
      onSectionChange={setActiveSection}
      selectedSessionId={selectedSessionId}
      onSelectSession={setSelectedSessionId}
    />

    // Update ChatPage rendering to pass props
    case "chat":
      return <ChatPage
        selectedSessionId={selectedSessionId}
        onSelectSession={setSelectedSessionId}
      />
    ```

    **Update ChatPage.tsx** - Accept props (implementation will come in Plan 2):
    ```typescript
    interface ChatPageProps {
      selectedSessionId: string | null
      onSelectSession: (sessionId: string | null) => void
    }

    export function ChatPage({ selectedSessionId, onSelectSession }: ChatPageProps) {
      // Keep placeholder for now, will be implemented in Plan 2
      return (
        <PageContainer fullWidth>
          <div className="flex flex-col items-center justify-center h-full min-h-[400px]">
            <h2 className="text-2xl font-semibold mb-2">Chat</h2>
            <p className="text-muted-foreground">
              {selectedSessionId ? `Session: ${selectedSessionId}` : 'New Chat - Start typing below'}
            </p>
          </div>
        </PageContainer>
      )
    }
    ```
  </action>
  <verify>
    1. `cd frontend && pnpm build` - Build succeeds
    2. `cd frontend && pnpm dev` - Start dev server, verify:
       - Sidebar shows "Chat History" section when on Chat tab
       - New Chat button (+ icon) visible
       - Empty state shows "No conversations yet" (if no sessions exist)
       - Loading skeletons appear briefly during data fetch
  </verify>
  <done>
    ChatSessionList component renders in sidebar when Chat tab is active. Session selection state flows from App to sidebar and ChatPage. New Chat button clears selection.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `cd frontend && pnpm build` passes
2. Dev server shows session list in sidebar (when Chat section active)
3. Clicking sessions changes selection (visible in ChatPage placeholder)
4. New Chat button resets to new chat state
5. Loading/error/empty states render correctly
</verification>

<success_criteria>
- Four shadcn components installed (scroll-area, collapsible, card, textarea)
- Three TanStack Query hooks created and type-checked
- ChatSessionList component integrated into sidebar
- Session state managed in App and passed to components
- Requirements CHAT-01, CHAT-02, CHAT-03 partially addressed (UI structure ready)
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat/02-01-SUMMARY.md`
</output>
