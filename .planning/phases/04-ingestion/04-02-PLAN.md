---
phase: 04-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/features/ingestion/hooks/useJobStatus.ts
  - frontend/src/features/ingestion/components/JobProgress.tsx
  - frontend/src/features/ingestion/components/JobStatusBadge.tsx
  - frontend/src/features/ingestion/IngestionPage.tsx
autonomous: true

must_haves:
  truths:
    - "User sees progress bar updating while job runs"
    - "User sees current file being processed"
    - "User sees toast notification when job completes"
    - "User sees inline completion indicator (green checkmark)"
    - "Polling stops when job completes or fails"
  artifacts:
    - path: "frontend/src/features/ingestion/hooks/useJobStatus.ts"
      provides: "Polling hook for job progress"
      exports: ["useJobStatus"]
    - path: "frontend/src/features/ingestion/components/JobProgress.tsx"
      provides: "Progress bar with stats"
      exports: ["JobProgress"]
    - path: "frontend/src/features/ingestion/components/JobStatusBadge.tsx"
      provides: "Colored status badge"
      exports: ["JobStatusBadge"]
  key_links:
    - from: "useJobStatus.ts"
      to: "/ingestion/status/{job_id}"
      via: "conditional refetchInterval"
      pattern: "refetchInterval.*=>.*false"
    - from: "IngestionPage.tsx"
      to: "useJobStatus.ts"
      via: "hook for progress polling"
      pattern: "useJobStatus\\(currentJobId\\)"
    - from: "JobProgress.tsx"
      to: "Progress component"
      via: "shadcn import"
      pattern: "import.*Progress.*from"
---

<objective>
Add real-time progress monitoring with automatic polling that updates the progress bar and current file status. Show toast notifications and inline visual updates when jobs complete or fail.

Purpose: Users can monitor their ingestion job progress without manual refresh
Output: Live progress display with automatic polling and completion notifications
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ingestion/04-CONTEXT.md
@.planning/phases/04-ingestion/04-RESEARCH.md
@.planning/phases/04-ingestion/04-01-SUMMARY.md
@frontend/src/types/api.ts
@frontend/src/features/ingestion/IngestionPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useJobStatus hook with conditional polling</name>
  <files>
    frontend/src/features/ingestion/hooks/useJobStatus.ts
  </files>
  <action>
1. Create `frontend/src/features/ingestion/hooks/useJobStatus.ts`:
   - Accept `jobId: string | null` parameter
   - Use `useQuery` with:
     - queryKey: `['ingestion', 'status', jobId]`
     - queryFn: calls `apiClient<TaskProgress>('/ingestion/status/${jobId}')`
     - enabled: `!!jobId`
     - refetchInterval as FUNCTION (not constant):
       ```typescript
       refetchInterval: (query) => {
         const data = query.state.data
         if (data?.status === 'completed' || data?.status === 'failed') {
           return false  // Stop polling
         }
         return 5000  // 5 second polling per CONTEXT.md
       }
       ```
   - Import `TaskProgress` from `@/types/api`

Key implementation detail: The refetchInterval MUST be a function that returns `false` when job is done. This is the TanStack Query v5 pattern for conditional polling.
  </action>
  <verify>
    TypeScript compiles: `cd frontend && pnpm tsc --noEmit`
  </verify>
  <done>
    useJobStatus hook polls every 5 seconds and stops when job completes/fails
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JobProgress and JobStatusBadge components</name>
  <files>
    frontend/src/features/ingestion/components/JobProgress.tsx
    frontend/src/features/ingestion/components/JobStatusBadge.tsx
  </files>
  <action>
1. Create `frontend/src/features/ingestion/components/JobStatusBadge.tsx`:
   - Accept `status: IngestionStatus` prop
   - Map statuses to badge variants per CONTEXT.md:
     - pending: outline, "Pending"
     - processing/chunking/indexing: default (blue), "Running"/"Chunking"/"Indexing"
     - completed: secondary with green override, "Complete"
     - failed: destructive (red), "Failed"
   - Use shadcn Badge component
   - For completed status, add `className="bg-green-500 hover:bg-green-500/80"` to override

2. Create `frontend/src/features/ingestion/components/JobProgress.tsx`:
   - Props: `progress: TaskProgress`, `compact?: boolean` (for table row display)
   - Use shadcn Progress component for the bar
   - Display layout (when not compact):
     - Top row: percentage left, "X/Y files" right
     - Progress bar
     - Current file text: "Processing: {current_file}" (truncate with `truncate` class)
   - Compact mode (for table): Just percentage and progress bar, no current file
   - Show stats: `{processed_documents}/{total_documents} files`
   - Handle undefined values: Use `progress_percentage ?? 0`
  </action>
  <verify>
    TypeScript compiles: `cd frontend && pnpm tsc --noEmit`
  </verify>
  <done>
    JobStatusBadge shows colored status, JobProgress shows progress bar with stats
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate progress monitoring into IngestionPage</name>
  <files>
    frontend/src/features/ingestion/IngestionPage.tsx
  </files>
  <action>
1. Add to IngestionPage:
   - Import `useJobStatus` hook
   - Import `JobProgress` and `JobStatusBadge` components
   - Import `toast` from `sonner`
   - Import `CheckCircle`, `XCircle` from `lucide-react`

2. Add polling:
   - Call `useJobStatus(currentJobId)` to get progress data
   - Destructure: `{ data: progress, isError: statusError }`

3. Add toast notifications using useEffect:
   - Track previous status with `useRef<string | undefined>()`
   - When status transitions TO 'completed':
     - `toast.success('Ingestion Complete', { description: 'Successfully processed X files' })`
   - When status transitions TO 'failed':
     - `toast.error('Ingestion Failed', { description: progress.error_message ?? 'Unknown error' })`
   - Only fire toast on TRANSITION (prevStatus !== currentStatus), not on initial load

4. Update progress display section:
   - After job ID display, show progress area when `progress` exists:
     - If status is completed: Show green checkmark with "Completed" text and file count
     - If status is failed: Show red X with error message
     - If status is running (pending/processing/chunking/indexing): Show JobProgress component
   - Per CONTEXT.md: Both toast AND inline visual update on completion

5. Show status badge next to job ID:
   - When progress exists, show JobStatusBadge next to job ID
  </action>
  <verify>
    - `cd frontend && pnpm build` succeeds
    - Start dev server and backend
    - Start an ingestion job
    - Progress bar updates every 5 seconds
    - Toast appears when job completes
    - Green checkmark shows inline after completion
  </verify>
  <done>
    Progress bar updates automatically, toast fires on completion, inline indicator shows
  </done>
</task>

</tasks>

<verification>
- Progress polling works with 5 second interval
- Polling stops when job completes or fails
- Toast notification appears on completion
- Toast notification appears on failure
- Inline visual indicator (green checkmark) shows on completion
- Progress percentage updates in real-time
- Current file being processed is displayed
</verification>

<success_criteria>
- INGE-07: Progress bar shows percentage complete
- INGE-08: Status text shows current state and file being processed
- INGE-09: Automatic polling updates progress while job is running
- INGE-12: Error handling for failed jobs (toast + inline)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ingestion/04-02-SUMMARY.md`
</output>
