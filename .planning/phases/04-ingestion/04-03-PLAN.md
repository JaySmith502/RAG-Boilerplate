---
phase: 04-ingestion
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/features/ingestion/hooks/useActiveJobs.ts
  - frontend/src/features/ingestion/components/JobHistoryTable.tsx
  - frontend/src/features/ingestion/components/JobHistorySkeleton.tsx
  - frontend/src/features/ingestion/IngestionPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of active/recent jobs"
    - "User sees loading skeleton while jobs load"
    - "User can see status badge for each job"
    - "User can expand failed jobs to see error details"
    - "User can retry failed jobs with one click"
  artifacts:
    - path: "frontend/src/features/ingestion/hooks/useActiveJobs.ts"
      provides: "Query for job list with background refresh"
      exports: ["useActiveJobs"]
    - path: "frontend/src/features/ingestion/components/JobHistoryTable.tsx"
      provides: "Table with expandable error rows"
      exports: ["JobHistoryTable"]
    - path: "frontend/src/features/ingestion/components/JobHistorySkeleton.tsx"
      provides: "Loading skeleton for job table"
      exports: ["JobHistorySkeleton"]
  key_links:
    - from: "useActiveJobs.ts"
      to: "/ingestion/jobs"
      via: "TanStack Query with refetchInterval"
      pattern: "apiClient.*ingestion/jobs"
    - from: "JobHistoryTable.tsx"
      to: "JobStatusBadge.tsx"
      via: "component import"
      pattern: "import.*JobStatusBadge"
    - from: "JobHistoryTable.tsx"
      to: "Collapsible"
      via: "expandable error details"
      pattern: "import.*Collapsible"
---

<objective>
Create a job history table showing active and recent ingestion jobs with status badges, expandable error details for failed jobs, and retry functionality.

Purpose: Users can track multiple jobs and diagnose/retry failures
Output: Job history table with status, progress, error details, and retry button
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ingestion/04-CONTEXT.md
@.planning/phases/04-ingestion/04-RESEARCH.md
@.planning/phases/04-ingestion/04-01-SUMMARY.md
@frontend/src/types/api.ts
@frontend/src/components/ui/table.tsx
@frontend/src/components/ui/collapsible.tsx
@frontend/src/features/retrieval/components/ResultsTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useActiveJobs hook</name>
  <files>
    frontend/src/features/ingestion/hooks/useActiveJobs.ts
  </files>
  <action>
1. Create `frontend/src/features/ingestion/hooks/useActiveJobs.ts`:
   - Use `useQuery` with:
     - queryKey: `['ingestion', 'jobs']`
     - queryFn: calls `apiClient<TaskProgress[]>('/ingestion/jobs')`
     - refetchInterval: `10000` (10 seconds - slower than individual job status)

2. Note on API response:
   - The `/ingestion/jobs` endpoint returns an array of TaskProgress objects directly
   - Jobs have 1 hour TTL in Redis, so this shows recent active jobs
   - No need for pagination for MVP (per RESEARCH.md open questions)
  </action>
  <verify>
    TypeScript compiles: `cd frontend && pnpm tsc --noEmit`
  </verify>
  <done>
    useActiveJobs hook fetches job list with 10 second background refresh
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JobHistoryTable and JobHistorySkeleton components</name>
  <files>
    frontend/src/features/ingestion/components/JobHistoryTable.tsx
    frontend/src/features/ingestion/components/JobHistorySkeleton.tsx
  </files>
  <action>
1. Create `frontend/src/features/ingestion/components/JobHistorySkeleton.tsx`:
   - Display 3 skeleton rows for the table
   - Match table structure: Job ID, Status, Progress, Actions columns
   - Use Skeleton component from shadcn

2. Create `frontend/src/features/ingestion/components/JobHistoryTable.tsx`:
   - Props:
     - `jobs: TaskProgress[]`
     - `onRetry?: (jobId: string, originalConfig?: IngestionJobRequest) => void`
   - Columns: Job ID (truncated), Status (badge), Progress, Actions
   - Use shadcn Table components (Table, TableHeader, TableBody, TableRow, TableCell, TableHead)

3. Job row implementation:
   - Create internal `JobRow` component for each job
   - Job ID: Show first 8 chars with "..." (font-mono text-xs)
   - Status: Use JobStatusBadge component
   - Progress column:
     - If running: Show compact JobProgress
     - If completed: Show "X/Y files" text
     - If failed: Show "Click for details" text
   - Completed rows: Add subtle green background `bg-green-50/50 dark:bg-green-950/20`
   - Completed rows: Show CheckCircle icon next to badge (inline visual indicator per CONTEXT.md)

4. Expandable error details for failed jobs:
   - Use Collapsible component
   - Failed rows are clickable (cursor-pointer)
   - Expanded state shows full error message in a red-tinted row
   - Show XCircle icon and "Error Details" heading
   - Display `job.error_message ?? 'Unknown error'`
   - Add chevron icon that rotates when expanded

5. Actions column:
   - Failed jobs: Show "Retry" button with RotateCcw icon
   - Retry button calls `onRetry(job.job_id)`
   - Use `e.stopPropagation()` on retry button to prevent row collapse toggle

6. Empty state:
   - If jobs array is empty, show centered message: "No ingestion jobs yet. Start one above!"
  </action>
  <verify>
    TypeScript compiles: `cd frontend && pnpm tsc --noEmit`
  </verify>
  <done>
    JobHistoryTable shows jobs with status badges, expandable errors, retry button
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate job history into IngestionPage</name>
  <files>
    frontend/src/features/ingestion/IngestionPage.tsx
  </files>
  <action>
1. Add imports:
   - Import `useActiveJobs` hook
   - Import `JobHistoryTable` and `JobHistorySkeleton` components
   - Import `Card`, `CardHeader`, `CardTitle`, `CardContent` if not already

2. Add job history section:
   - Call `useActiveJobs()` hook
   - Destructure: `{ data: jobs, isPending: jobsLoading }`

3. Add retry handler:
   - Create `handleRetry` function that takes jobId
   - For MVP: Retry just restarts with default config (since backend doesn't return original config)
   - Call `startJob.mutate()` with a basic request (user will need to re-select folder)
   - Alternative: Show toast saying "Retry: Please configure and start a new job" (simpler for MVP)
   - Per CONTEXT.md: "one-click restart with same config" - but backend limitation means we inform user

4. Layout structure:
   - After the form card and progress section
   - Add new Card for "Job History":
     - CardHeader with CardTitle "Job History"
     - CardContent containing:
       - If jobsLoading: Show JobHistorySkeleton
       - Else: Show JobHistoryTable with jobs and onRetry handler

5. Page layout order:
   - Header (title + description)
   - Form Card (IngestionForm)
   - Current job progress (if currentJobId exists)
   - Job History Card (JobHistoryTable)
  </action>
  <verify>
    - `cd frontend && pnpm build` succeeds
    - Start dev server and backend
    - Job history table shows active jobs
    - Loading skeleton shows while fetching
    - Failed jobs can be expanded to show error
    - Status badges show correct colors
  </verify>
  <done>
    Job history table integrated, shows all active jobs with status and error handling
  </done>
</task>

</tasks>

<verification>
- Job history table renders with correct columns
- Jobs load with skeleton placeholder
- Status badges show correct colors (blue=running, green=complete, red=failed)
- Failed job rows are expandable
- Error message displays when failed job expanded
- Retry button appears on failed jobs
- Empty state shows when no jobs
- Completed jobs show green tint and checkmark
</verification>

<success_criteria>
- INGE-10: Job history table shows active and recent jobs
- INGE-11: Loading state for job list (skeleton)
- INGE-12: Error handling for failed jobs (expandable details, retry button)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ingestion/04-03-SUMMARY.md`
</output>
